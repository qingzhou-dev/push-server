# push-server

![Spring Boot](https://img.shields.io/badge/Spring%20Boot-4.0+-green.svg)
![Java](https://img.shields.io/badge/Java-25%2B-blue.svg)
![GraalVM](https://img.shields.io/badge/GraalVM-Native-orange.svg)
![License](https://img.shields.io/badge/License-Apache%202.0-red.svg)

**push-server** æ˜¯ä¸€ä¸ªåŸºäº Spring Boot 4 æ„å»ºçš„è½»é‡çº§ä¼ä¸šå¾®ä¿¡æ¨é€æœåŠ¡ã€‚å®ƒå°è£…äº†ä¼ä¸šå¾®ä¿¡å¤æ‚çš„ APIï¼Œå¯¹å¤–æä¾›æå…¶ç®€å•çš„ HTTP æ¥å£ï¼Œæ”¯æŒ Docker åŸç”Ÿé•œåƒéƒ¨ç½²ï¼ˆå¯åŠ¨ä»…éœ€ 0.1sï¼Œå†…å­˜å ç”¨ <50MBï¼‰ã€‚

---

## ğŸ“– é¡¹ç›®å®šä½ä¸ç›®æ ‡

**push-server** çš„æ ¸å¿ƒç›®æ ‡æ˜¯ï¼š

> **é€šè¿‡ä¼ä¸šå¾®ä¿¡ï¼ˆWeComï¼‰ï¼Œå°†ç³»ç»Ÿæ¶ˆæ¯ç¨³å®šã€åˆè§„åœ°æ¨é€åˆ°ç”¨æˆ·çš„å¾®ä¿¡ä¸­æ¥æ”¶ã€‚**

æ•´ä½“æ¶ˆæ¯æµè½¬è·¯å¾„å¦‚ä¸‹ï¼š

```mermaid
flowchart LR
  A[ä¸šåŠ¡ç³»ç»Ÿ / æœåŠ¡] -->|HTTPè¯·æ±‚| B[push-server]
  B -->|ä¼ä¸šå¾®ä¿¡ API| C[ä¼ä¸šå¾®ä¿¡æœåŠ¡ç«¯]
    C --> D[å¾®ä¿¡ App]

```

æœ€ç»ˆæ•ˆæœæ˜¯ï¼š
**ç”¨æˆ·åœ¨å¾®ä¿¡ä¸­æ”¶åˆ°æ¶ˆæ¯ï¼Œä½†æŠ€æœ¯é€šé“ä½¿ç”¨çš„æ˜¯ä¼ä¸šå¾®ä¿¡ã€‚**

### ä¸ºä»€ä¹ˆé€‰æ‹©ä¼ä¸šå¾®ä¿¡ï¼Ÿ

ç›¸æ¯”å¾®ä¿¡å…¬ä¼—å·ï¼Œä¼ä¸šå¾®ä¿¡å…·å¤‡å¤©ç„¶çš„ç³»ç»Ÿé€šçŸ¥ä¼˜åŠ¿ï¼š

* âœ… **æ— ç¼è§¦è¾¾**ï¼šæ¶ˆæ¯æœ€ç»ˆå¯åˆ°è¾¾ **å¾®ä¿¡ App**ï¼ˆéœ€å…³æ³¨æ’ä»¶ï¼‰ã€‚
* âœ… **ä¸»åŠ¨æ¨é€**ï¼šæ”¯æŒæ— é™åˆ¶çš„ä¸»åŠ¨æ¶ˆæ¯æ¨é€ï¼Œé€‚åˆå‘Šè­¦ã€é€šçŸ¥ã€‚
* âœ… **ç¨³å®šåˆè§„**ï¼šå®˜æ–¹å…è®¸çš„ç³»ç»Ÿæ¶ˆæ¯é€šé“ï¼Œä¸æ¶‰åŠå†…å®¹é£æ§ã€‚
* âœ… **ç®€å•æ˜“ç”¨**ï¼šæ— éœ€å¤æ‚çš„æ¨¡æ¿æ¶ˆæ¯ç”³è¯·ï¼Œå¼€å‘æ¥å£æ¸…æ™°ã€‚

**push-server** çš„è§’è‰²éå¸¸çº¯ç²¹ï¼šå®ƒä¸å…³å¿ƒä¸šåŠ¡å«ä¹‰ï¼Œåªä½œä¸ºä¸€ä¸ª**å¯é çš„æ¶ˆæ¯æŠ•é€’ç®¡é“**ã€‚

---

## âš¡ï¸ æ ¸å¿ƒç‰¹æ€§

* **è½»é‡çº§**ï¼šåŸºäº Spring Boot 4 + GraalVM Native Imageï¼Œæè‡´çš„å¯åŠ¨é€Ÿåº¦å’Œèµ„æºå ç”¨ã€‚
* **å¼€ç®±å³ç”¨**ï¼šæ— éœ€æ•°æ®åº“ï¼Œæ— éœ€å¤æ‚é…ç½®ï¼Œåªéœ€å¡«å†™ API Key å³å¯è¿è¡Œã€‚
* **æ ‡å‡†åŒ– API**ï¼šç»Ÿä¸€çš„ HTTP æ¥å£ï¼Œå±è”½ä¸åŒæ¸ é“çš„å®ç°ç»†èŠ‚ã€‚
* **å®¹å™¨å‹å¥½**ï¼šæä¾› Docker é•œåƒï¼Œæ”¯æŒç¯å¢ƒå˜é‡é…ç½®ï¼Œå®Œç¾é€‚é… K8sã€‚
* **æ‰©å±•æ€§å¼º**ï¼šåº•å±‚ä¾èµ– `push-core`ï¼ŒåŸºäº SPI æ¶æ„ï¼Œæ˜“äºæ‰©å±•å…¶ä»–æ¸ é“ã€‚
* **å®‰å…¨æ‹¦æˆª**ï¼šAPI Key æ ¡éªŒ + å¤±è´¥æ¬¡æ•°å°ç¦ï¼Œé™ä½æš´åŠ›è¯·æ±‚é£é™©ã€‚

---

## ğŸ›  å‰ç½®å‡†å¤‡

åœ¨ä½¿ç”¨æœ¬æœåŠ¡å‰ï¼Œä½ éœ€è¦å®Œæˆä¼ä¸šå¾®ä¿¡ä¾§çš„é…ç½®ï¼š

1. **æ³¨å†Œä¼ä¸šå¾®ä¿¡**ï¼šä¸ªäººä¹Ÿå¯ä»¥å…è´¹æ³¨å†Œã€‚
2. **åˆ›å»ºè‡ªå»ºåº”ç”¨**ï¼š
* è¿›å…¥ [ä¼ä¸šå¾®ä¿¡ç®¡ç†åå°](https://work.weixin.qq.com/wework_admin/frame) -> `åº”ç”¨ç®¡ç†` -> `åˆ›å»ºåº”ç”¨`ã€‚
* è·å– **AgentId** å’Œ **Secret**ï¼ˆå¯¹åº”é…ç½®ä¸­çš„ `push.wecom.agent-id` ä¸ `push.wecom.app-secret`ï¼‰ã€‚
* è·å– **ä¼ä¸šID (CorpId)**ï¼ˆå¯¹åº”é…ç½®ä¸­çš„ `push.wecom.app-key`ï¼‰ã€‚


3. **å…³é”®æ­¥éª¤**ï¼š
* è¿›å…¥ `æˆ‘çš„ä¼ä¸š` -> `å¾®ä¿¡æ’ä»¶`ã€‚
* ç”¨ä½ çš„ä¸ªäººå¾®ä¿¡æ‰«æäºŒç»´ç ï¼Œ**å…³æ³¨è¯¥ä¼ä¸š**ã€‚
* *æ³¨æ„ï¼šåªæœ‰å…³æ³¨åï¼Œæ¶ˆæ¯æ‰èƒ½ç›´æ¥åœ¨å¾®ä¿¡ App ä¸­é€šè¿‡â€œæœåŠ¡é€šçŸ¥â€å¼¹å‡ºã€‚*



---

## ğŸš€ å¿«é€Ÿå¼€å§‹ (Docker)

æ¨èä½¿ç”¨ Docker è¿è¡Œï¼Œæ— éœ€å®‰è£… Java ç¯å¢ƒã€‚

### æ–¹å¼ä¸€ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡å¯åŠ¨ (æœ€å¿«)

ç›´æ¥å°†é…ç½®å‚æ•°é€šè¿‡ `-e` ä¼ å…¥ï¼š

```bash
docker run -d \
  --name push-server \
  -p 8000:8000 \
  -e PUSH_AUTH_KEY="æ›¿æ¢ä¸ºè‡ªå·±çš„key" \
  -e PUSH_WECOM_APP_KEY="ä½ çš„åº”ç”¨AppKey" \
  -e PUSH_WECOM_APP_SECRET="ä½ çš„åº”ç”¨AppSecret" \
  -e PUSH_WECOM_AGENT_ID="1000001" \
  qingzhou/push-server:latest

```

### æ–¹å¼äºŒï¼šæŒ‚è½½é…ç½®æ–‡ä»¶ (æ¨è)

å¦‚æœä½ å¸Œæœ›ç®¡ç†é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥æŒ‚è½½å®¿ä¸»æœºçš„ `application.yml`ï¼š

1. åˆ›å»º `application.yml` æ–‡ä»¶ï¼š
```yaml
push:
  auth:
    key: "æ›¿æ¢ä¸ºè‡ªå·±çš„key"
  security:
    block-minutes: 30
    fail-window-minutes: 5
    max-fails: 5
  wecom:
    app-key: "ä½ çš„åº”ç”¨AppKey"
    app-secret: "ä½ çš„åº”ç”¨AppSecret"
    agent-id: "1000001"
    webhook-url:

```


2. å¯åŠ¨å®¹å™¨ï¼š
```bash
docker run -d \
  --name push-server \
  -p 8000:8000 \
  -v $(pwd)/application.yml:/workspace/config/application.yml \
  qingzhou/push-server:latest

```



---

## ğŸ”Œ API æ–‡æ¡£

æœåŠ¡å¯åŠ¨åï¼Œé»˜è®¤ç›‘å¬ `8000` ç«¯å£ã€‚

### å‘é€æ¶ˆæ¯æ¥å£

* **URL**: `/v1/push`
* **Method**: `POST`
* **Content-Type**: `application/json`
* **Header**: `X-API-Key: <push.auth.key>`

#### è¯·æ±‚å‚æ•°ç¤ºä¾‹

**1. å‘é€æ™®é€šæ–‡æœ¬ (Text)**

```bash
curl -X POST http://localhost:8000/v1/push \
  -H "X-API-Key: æ›¿æ¢ä¸ºè‡ªå·±çš„key" \
  -H "Content-Type: application/json" \
  -d '{
    "target": "ZhangSan|LiSi",
    "type": "TEXT",
    "content": "ç³»ç»Ÿé€šçŸ¥ï¼šæ‚¨çš„ä»»åŠ¡å·²æ„å»ºå®Œæˆã€‚"
  }'

```

*æ³¨ï¼š`target` ä¸ºä¼ä¸šå¾®ä¿¡é€šè®¯å½•ä¸­çš„ `UserID`ï¼Œå¤šäººç”¨ `|` åˆ†éš”ï¼Œ`@all` è¡¨ç¤ºå‘ç»™æ‰€æœ‰äººã€‚*

**2. å‘é€ Markdown (æ¨è)**

```bash
curl -X POST http://localhost:8000/v1/push \
  -H "X-API-Key: æ›¿æ¢ä¸ºè‡ªå·±çš„key" \
  -H "Content-Type: application/json" \
  -d '{
    "target": "@all",
    "type": "MARKDOWN",
    "title": "ç”Ÿäº§ç¯å¢ƒå‘Šè­¦",
    "content": "**âš ï¸ ç”Ÿäº§ç¯å¢ƒå‘Šè­¦**\n> æœåŠ¡ï¼š`Order-Service`\n> çŠ¶æ€ï¼š<font color=\"warning\">é«˜è´Ÿè½½ (90%)</font>\n> [æŸ¥çœ‹è¯¦æƒ…](http://monitor.com)"
  }'

```

`type` ä¸ºç©ºæ—¶é»˜è®¤ `TEXT`ï¼Œæ”¯æŒï¼š`TEXT`ã€`MARKDOWN`ã€`TEXT_CARD`ã€`IMAGE`ã€`NEWS`ã€‚
é‰´æƒå¤±è´¥æ¬¡æ•°è¶…è¿‡é˜ˆå€¼æ—¶ä¼šè§¦å‘å°ç¦å¹¶è¿”å› `429`ï¼Œé˜ˆå€¼ä¸æ—¶é•¿å¯åœ¨ `push.security` ä¸­é…ç½®ã€‚

---

## âš™ï¸ é…ç½®è¯´æ˜

å®Œæ•´çš„ `application.yml` é…ç½®é¡¹å¦‚ä¸‹ï¼š

```yaml
server:
  port: 8000

push:
  auth:
    key: "æ›¿æ¢ä¸ºè‡ªå·±çš„key"
  security:
    # å¦‚æœä¸é…ç½®æˆ–é…ç½®ä¸º nullï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼
    block-minutes: 30      # å°ç¦æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
    fail-window-minutes: 5 # å¤±è´¥è®¡æ•°çª—å£ï¼ˆåˆ†é’Ÿï¼‰
    max-fails: 5           # çª—å£å†…æœ€å¤§å¤±è´¥æ¬¡æ•°
  wecom:
    app-key: ""     # åº”ç”¨ AppKey
    app-secret: ""  # åº”ç”¨ AppSecret
    agent-id: ""    # åº”ç”¨ AgentId
    webhook-url: "" # å¯é€‰

```

---
